<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>DASHBOARD DE AVARIAS - MS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

    <style>
        :root { --red: #b30000; --blue: #004080; --dark-blue: #002d5a; --bg: #f0f4f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        
        .header { background: var(--red); color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .back-btn { position: absolute; left: 15px; top: 18px; color: white; text-decoration: none; font-weight: bold; border: 1px solid white; padding: 5px 12px; border-radius: 4px; font-size: 13px; }
        .exit-btn { position: absolute; right: 15px; top: 18px; color: white; background: transparent; border: 1px solid white; padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
        .big-number { font-size: 48px; font-weight: bold; color: var(--red); margin: 5px 0; }
        canvas { max-height: 250px; width: 100% !important; }

        .table-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-top: 4px solid var(--red); }
        .table-title { color: var(--red); margin-top: 0; margin-bottom: 15px; font-size: 18px; text-transform: uppercase; font-weight: bold; }
        
        table.dataTable thead th { background: var(--blue) !important; color: white !important; text-align: center !important; font-size: 11px; text-transform: uppercase; border: 1px solid var(--dark-blue) !important; padding: 10px 5px !important; }
        table.dataTable tbody td { text-align: center !important; padding: 8px !important; border: 1px solid #eee !important; font-size: 13px; }

        .filter-btn { width: 90%; margin: 4px auto 0; padding: 3px 0; font-size: 9px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); border-radius: 3px; cursor: pointer; display: block; }
        .filter-applied { background: #FFD700 !important; color: #000 !important; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 320px; border-radius: 8px; display: flex; flex-direction: column; }
        .modal-header { background: var(--blue); color: white; padding: 15px; font-weight: bold; text-align: center; }
        .modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px; background: #f1f1f1; }
        .btn-aplicar { grid-column: span 2; background: var(--red); color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <a href="historico.html" class="back-btn">← VOLTAR</a>
    <h1>RELATÓRIO DE AVARIAS (MÓVEIS SIMONETTI)</h1>
    <button class="exit-btn" onclick="fazerLogoff()">SAIR</button>
</div>

<div class="grid">
    <div class="card">
        <h3>TOTAL CARGAS (SIM)</h3>
        <div id="totalAvarias" class="big-number">0</div>
        <p id="totalPercent" style="font-weight:bold; color: #666;">--% do total</p>
    </div>
    <div class="card"><h3>AVARIAS POR VEÍCULO</h3><canvas id="chartVeiculos"></canvas></div>
    <div class="card"><h3>TOP 5 DESTINOS</h3><canvas id="chartDestinos"></canvas></div>
    <div class="card"><h3>AVARIAS POR EQUIPE</h3><canvas id="chartEquipe"></canvas></div>
</div>

<div class="table-section">
    <h3 class="table-title">DETALHAMENTO DAS CARGAS AVARIADAS</h3>
    <table id="tabelaAvarias" class="display nowrap" style="width:100%">
        <thead><tr id="headerRow"></tr></thead>
        <tbody></tbody>
    </table>
</div>

<div id="modalFiltro" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">FILTRAR</div>
        <div id="listCheckboxes" style="max-height: 300px; overflow-y: auto; padding: 10px;"></div>
        <div class="modal-footer">
            <button onclick="$('#modalFiltro').hide()">FECHAR</button>
            <button class="btn-aplicar" onclick="aplicarFiltro()">APLICAR</button>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
const csvUrl = "https://docs.google.com/spreadsheets/d/1-t9-DE1erEwcgZWVHMHq5JWBqWYAnZvh-_01__3fHno/export?format=csv&gid=804780494";
// Removi a QTD da lista de colunas para não dar erro de contagem na tabela
const colunasVisiveis = ["DATA", "EXPEDIÇÃO", "PLACA", "DESTINO", "VEICULO", "CARREGAMENTO"];
let table, charts = {};
let totalGeralCargas = 0;
let dadosCompletos = [];

$(document).ready(function() {
    const hRow = $("#headerRow");
    colunasVisiveis.forEach((c, i) => {
        hRow.append(`<th>${c}<button class="filter-btn" id="fbtn-${i}" onclick="event.stopPropagation(); openModal(${i},'${c}')">FILTRAR</button></th>`);
    });

    Papa.parse(csvUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: res => {
            dadosCompletos = res.data;
            const setTotal = new Set();
            dadosCompletos.forEach(r => { if(r.DATA && r.QTD) setTotal.add(`${r.DATA}_${r.QTD}`); });
            totalGeralCargas = setTotal.size;
            
            inicializarTabela(dadosCompletos.filter(r => (r.AVARIA || "").toUpperCase().trim() === "SIM"));
        }
    });
});

function inicializarTabela(dadosAvaria) {
    const body = $("#tabelaAvarias tbody").empty();
    dadosAvaria.forEach(r => {
        body.append(`<tr>
            <td>${r.DATA || ""}</td>
            <td>${r["EXPEDIÇÃO"] || r.EXPEDICAO || ""}</td>
            <td>${r.PLACA || ""}</td>
            <td>${r.DESTINO || ""}</td>
            <td>${r.VEICULO || ""}</td>
            <td>${r.CARREGAMENTO || ""}</td>
            <td style="display:none">${r.QTD}</td> </tr>`);
    });

    table = $('#tabelaAvarias').DataTable({ 
        paging: false, info: false, dom: 'rt', scrollX: true, ordering: true,
        drawCallback: function() { atualizarDashboards(); }
    });
}

function atualizarDashboards() {
    const rows = table.rows({ search: 'applied' }).data().toArray();
    const cargasUnicas = new Set();
    const mapEquipe = {}, mapVeiculo = {}, mapDestino = {};

    rows.forEach(r => {
        // r[6] é a coluna QTD que está oculta
        const chave = `${r[0]}_${r[6]}`; 
        if(!cargasUnicas.has(chave)) {
            cargasUnicas.add(chave);
            if(r[5]) mapEquipe[r[5]] = (mapEquipe[r[5]] || 0) + 1;
            if(r[4]) mapVeiculo[r[4]] = (mapVeiculo[r[4]] || 0) + 1;
            if(r[3]) mapDestino[r[3]] = (mapDestino[r[3]] || 0) + 1;
        }
    });

    const totalAvarias = cargasUnicas.size;
    $("#totalAvarias").text(totalAvarias);
    const perc = totalGeralCargas > 0 ? ((totalAvarias / totalGeralCargas) * 100).toFixed(1) : 0;
    $("#totalPercent").text(`${perc}% do total de cargas`);

    renderChart('chartVeiculos', 'pie', mapVeiculo);
    renderChart('chartEquipe', 'bar', mapEquipe);
    const top5Destinos = Object.entries(mapDestino).sort((a,b) => b[1] - a[1]).slice(0, 5);
    renderChart('chartDestinos', 'bar', Object.fromEntries(top5Destinos), true);
}

function renderChart(id, type, dataObj, isDestino = false) {
    if(charts[id]) charts[id].destroy();
    const labels = Object.keys(dataObj);
    const values = Object.values(dataObj);
    const total = values.reduce((a, b) => a + b, 0);

    charts[id] = new Chart(document.getElementById(id), {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: isDestino ? '#b30000' : ['#b30000', '#004080', '#ff6600', '#28a745', '#6f42c1']
            }]
        },
        options: {
            plugins: {
                legend: { display: type === 'pie', position: 'bottom' },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 10 },
                    formatter: (value) => {
                        const p = ((value / total) * 100).toFixed(1);
                        return `${value} (${p}%)`;
                    }
                }
            },
            scales: type === 'bar' ? { 
                y: { display: false }, 
                x: { grid: { display: false }, ticks: { font: { size: 9 } } } 
            } : {}
        }
    });
}

function openModal(idx, title) {
    curIdx = idx;
    $("#modalTitle").text(title);
    const list = $("#listCheckboxes").empty();
    const uniqueVals = table.column(idx).data().unique().sort().toArray();
    uniqueVals.forEach(v => {
        list.append(`<label style="display:block; padding:8px; border-bottom:1px solid #eee;"><input type="checkbox" value="${v}" checked> ${v}</label>`);
    });
    $("#modalFiltro").css("display", "flex");
}

function aplicarFiltro() {
    const sel = $("#listCheckboxes input:checked").map(function(){ return this.value; }).get();
    const regex = sel.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
    table.column(curIdx).search(sel.length ? regex : 'NONE', true, false).draw();
    $(`#fbtn-${curIdx}`).addClass("filter-applied");
    $("#modalFiltro").hide();
}

function fazerLogoff() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>
</html>
