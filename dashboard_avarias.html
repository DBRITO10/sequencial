<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>DASHBOARD DE AVARIAS - MS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

    <style>
        :root { --red: #b30000; --blue: #004080; --dark-blue: #002d5a; --bg: #f0f4f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        
        .header { background: var(--red); color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; position: relative; }
        .back-btn { position: absolute; left: 15px; top: 18px; color: white; text-decoration: none; font-weight: bold; border: 1px solid white; padding: 5px 12px; border-radius: 4px; font-size: 13px; }
        .exit-btn { position: absolute; right: 15px; top: 18px; color: white; background: transparent; border: 1px solid white; padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; min-height: 300px; display: flex; flex-direction: column; justify-content: center; }
        .big-number { font-size: 48px; font-weight: bold; color: var(--red); margin: 5px 0; }
        
        canvas { max-height: 220px !important; width: 100% !important; }

        .table-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-top: 4px solid var(--red); }
        .table-title { color: var(--red); margin-top: 0; margin-bottom: 15px; font-size: 18px; text-transform: uppercase; font-weight: bold; }
        
        /* Estilo Cabeçalho Tabela */
        table.dataTable thead th { background: var(--blue) !important; color: white !important; text-align: center !important; font-size: 11px; text-transform: uppercase; border: 1px solid var(--dark-blue) !important; padding: 10px !important; }
        table.dataTable tbody td { text-align: center !important; padding: 8px !important; border: 1px solid #eee !important; font-size: 13px; }

        .filter-btn { width: 90%; margin: 5px auto 0; padding: 3px 0; font-size: 9px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); border-radius: 3px; cursor: pointer; display: block; font-weight: bold; }
        .filter-applied { background: #FFD700 !important; color: #000 !important; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 320px; border-radius: 8px; display: flex; flex-direction: column; }
        .modal-header { background: var(--blue); color: white; padding: 15px; font-weight: bold; text-align: center; }
        .modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px; background: #f1f1f1; }
        .btn-aplicar { grid-column: span 2; background: var(--red); color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <a href="historico.html" class="back-btn">← VOLTAR</a>
    <h1>DASHBOARD DE AVARIAS (MÓVEIS SIMONETTI)</h1>
    <button class="exit-btn" onclick="fazerLogoff()">SAIR</button>
</div>

<div class="grid">
    <div class="card">
        <h3>TOTAL CARGAS COM AVARIA</h3>
        <div id="totalAvarias" class="big-number">0</div>
        <p id="totalPercent" style="font-weight:bold; color: #666;">Calculando...</p>
    </div>
    <div class="card"><h3>AVARIAS POR VEÍCULO</h3><canvas id="chartVeiculos"></canvas></div>
    <div class="card"><h3>TOP 5 DESTINOS</h3><canvas id="chartDestinos"></canvas></div>
    <div class="card"><h3>AVARIAS POR EQUIPE</h3><canvas id="chartEquipe"></canvas></div>
</div>

<div class="table-section">
    <h3 class="table-title">DETALHAMENTO (SOMENTE AVARIAS SIM)</h3>
    <table id="tabelaAvarias" class="display nowrap" style="width:100%">
        <thead>
            <tr>
                <th>DATA</th>
                <th>EXPEDIÇÃO</th>
                <th>PLACA</th>
                <th>DESTINO</th>
                <th>VEICULO</th>
                <th>CARREGAMENTO</th>
                <th style="display:none">QTD</th> </tr>
            <tr id="filterRow">
                <th><button class="filter-btn" onclick="openModal(0,'DATA')">FILTRAR</button></th>
                <th><button class="filter-btn" onclick="openModal(1,'EXPEDIÇÃO')">FILTRAR</button></th>
                <th><button class="filter-btn" onclick="openModal(2,'PLACA')">FILTRAR</button></th>
                <th><button class="filter-btn" onclick="openModal(3,'DESTINO')">FILTRAR</button></th>
                <th><button class="filter-btn" onclick="openModal(4,'VEICULO')">FILTRAR</button></th>
                <th><button class="filter-btn" onclick="openModal(5,'EQUIPE')">FILTRAR</button></th>
                <th style="display:none"></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="modalFiltro" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">FILTRAR</div>
        <div id="listCheckboxes" style="max-height: 300px; overflow-y: auto; padding: 10px;"></div>
        <div class="modal-footer">
            <button onclick="$('#modalFiltro').hide()">FECHAR</button>
            <button class="btn-aplicar" onclick="aplicarFiltro()">APLICAR</button>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);
const csvUrl = "https://docs.google.com/spreadsheets/d/1-t9-DE1erEwcgZWVHMHq5JWBqWYAnZvh-_01__3fHno/export?format=csv&gid=804780494";
let table, charts = {}, curIdx, totalCargasBase = 0;

$(document).ready(function() {
    Papa.parse(csvUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: res => {
            const todosOsDados = res.data;
            
            // 1. REGRA: Calcular total geral de cargas (SIM e NÃO) para a % do card
            const totalSet = new Set();
            todosOsDados.forEach(r => { 
                if(r.DATA && r.QTD) totalSet.add(`${r.DATA}_${r.QTD}`); 
            });
            totalCargasBase = totalSet.size;

            // 2. REGRA: Filtrar a tabela para mostrar APENAS AVARIA = SIM
            const apenasAvarias = todosOsDados.filter(r => (r.AVARIA || "").toUpperCase().trim() === "SIM");
            
            montarTabela(apenasAvarias);
        }
    });
});

function montarTabela(dados) {
    const tbody = $("#tabelaAvarias tbody").empty();
    dados.forEach(r => {
        tbody.append(`<tr>
            <td>${r.DATA || ""}</td>
            <td>${r["EXPEDIÇÃO"] || r.EXPEDICAO || ""}</td>
            <td>${r.PLACA || ""}</td>
            <td>${r.DESTINO || ""}</td>
            <td>${r.VEICULO || ""}</td>
            <td>${r.CARREGAMENTO || ""}</td>
            <td style="display:none">${r.QTD || ""}</td>
        </tr>`);
    });

    // Inicializa DataTable com ordenação e scroll
    table = $('#tabelaAvarias').DataTable({
        paging: false, info: false, scrollX: true, ordering: true, orderCellsTop: true,
        drawCallback: function() { atualizarDashboards(); }
    });
}

function atualizarDashboards() {
    // Pega apenas as linhas que sobraram após o filtro da tabela
    const dadosFiltrados = table.rows({ search: 'applied' }).data().toArray();
    
    const cargasUnicas = new Set();
    const mapEq = {}, mapVeic = {}, mapDest = {};

    dadosFiltrados.forEach(r => {
        const chaveCarga = `${r[0]}_${r[6]}`; // DATA + QTD
        if(!cargasUnicas.has(chaveCarga)) {
            cargasUnicas.add(chaveCarga);
            if(r[5]) mapEq[r[5]] = (mapEq[r[5]] || 0) + 1;
            if(r[4]) mapVeic[r[4]] = (mapVeic[r[4]] || 0) + 1;
            if(r[3]) mapDest[r[3]] = (mapDest[r[3]] || 0) + 1;
        }
    });

    const totalAvariasAgora = cargasUnicas.size;
    $("#totalAvarias").text(totalAvariasAgora);
    
    // Porcentagem em relação ao total da planilha
    const perc = totalCargasBase > 0 ? ((totalAvariasAgora / totalCargasBase) * 100).toFixed(1) : 0;
    $("#totalPercent").text(`${perc}% do volume total de cargas`);

    // Atualiza Gráficos com os novos dados filtrados
    renderChart('chartVeiculos', 'pie', mapVeic);
    renderChart('chartEquipe', 'bar', mapEq);
    const top5 = Object.entries(mapDest).sort((a,b) => b[1] - a[1]).slice(0, 5);
    renderChart('chartDestinos', 'bar', Object.fromEntries(top5), true);
}

function renderChart(id, type, dataObj, destaqueRed = false) {
    if(charts[id]) charts[id].destroy();
    
    const labels = Object.keys(dataObj);
    const values = Object.values(dataObj);
    const total = values.reduce((a, b) => a + b, 0);

    charts[id] = new Chart(document.getElementById(id), {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: destaqueRed ? '#b30000' : ['#b30000', '#004080', '#ff6600', '#28a745', '#6f42c1']
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { display: type === 'pie', position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 11 },
                    formatter: (val) => {
                        const p = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                        return type === 'pie' ? `${val}\n(${p}%)` : `${val} (${p}%)`;
                    }
                }
            },
            scales: type === 'bar' ? { 
                y: { display: false }, 
                x: { grid: { display: false }, ticks: { font: { size: 9 } } } 
            } : {}
        }
    });
}

function openModal(idx, title) {
    curIdx = idx;
    $("#modalTitle").text(title);
    const list = $("#listCheckboxes").empty();
    const uniqueVals = table.column(idx, {search:'applied'}).data().unique().sort().toArray();
    
    uniqueVals.forEach(v => {
        list.append(`<label style="display:block; padding:8px; border-bottom:1px solid #eee;"><input type="checkbox" value="${v}" checked> ${v}</label>`);
    });
    $("#modalFiltro").css("display", "flex");
}

function aplicarFiltro() {
    const selecionados = $("#listCheckboxes input:checked").map(function(){ return this.value; }).get();
    const regex = selecionados.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
    table.column(curIdx).search(selecionados.length ? regex : 'NADA_SELECIONADO', true, false).draw();
    $("#modalFiltro").hide();
}

function fazerLogoff() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>
</html>
