<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>EXPEDI√á√ÉO SIMONETTI - OFICIAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

    <style>
        :root { 
            --red: #B22222; 
            --dark-red: #8B0000;
            --user-bar-bg: #d32f2f;
            --bg: #f8f9fa; 
        }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; }
        
        #userBar { background: var(--user-bar-bg); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; color: white; margin-bottom: 10px; }
        .back-area { display: flex; align-items: center; gap: 15px; }
        .back-arrow { cursor: pointer; font-size: 24px; text-decoration: none; color: white; }
        
        h1 { background: var(--red); color: white; text-align: center; padding: 15px; border-radius: 4px; margin: 0 0 20px 0; font-size: 20px; text-transform: uppercase; }

        /* Melhoria do Dashboard para 2 gr√°ficos */
        .dashboard { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .dashboard-row { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 100%; }
        .chart-box { flex: 1; min-width: 300px; max-width: 450px; height: 320px; }
        
        #totalVisual { 
            font-size: 18px; font-weight: bold; color: var(--red); 
            margin: 20px auto 0; border: 2px solid var(--red); 
            padding: 10px 25px; border-radius: 50px; background: #fff; 
            text-align: center; max-width: fit-content;
        }

        .toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; align-items: center; }
        #mainSearch { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 220px; outline: none; }
        
        .dropdown { position: relative; display: inline-block; }
        .btn-share { background: #1E90FF; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .dropdown-content { 
            display: none; position: absolute; right: 0; background-color: #ffffff; 
            min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); 
            z-index: 1000; border-radius: 6px; margin-top: 5px; border: 1px solid #ddd;
        }
        .dropdown-content.show { display: block; }
        .dropdown-content button { 
            color: #333; padding: 12px 16px; display: block; width: 100%; border: none; 
            background: none; text-align: left; cursor: pointer; font-size: 14px; border-bottom: 1px solid #eee;
        }
        .dropdown-content button:hover { background-color: #f1f1f1; }

        .table-container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        
        /* Corre√ß√£o das setas de ordena√ß√£o e alinhamento fixo */
        table.dataTable thead th { 
            background: var(--red) !important; color: white !important; 
            text-align: center !important; padding: 12px 30px 12px 10px !important;
            border: 1px solid var(--dark-red) !important; font-size: 13px;
            position: relative; /* Base para o posicionamento das setas */
        }
        
        /* Garante que as setas do DataTable n√£o "empurrem" o texto */
        table.dataTable thead .sorting::after, 
        table.dataTable thead .sorting_asc::after, 
        table.dataTable thead .sorting_desc::after { 
            right: 8px !important; 
        }

        .filter-btn { 
            width: 90%; margin-top: 5px; padding: 3px; font-size: 9px; 
            background: rgba(0,0,0,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 3px; cursor: pointer; font-weight: bold;
        }
        .filter-applied { background: #FFD700 !important; color: #000 !important; }

        table.dataTable tbody td { border: 1px solid #dee2e6 !important; text-align: center !important; padding: 10px !important; font-size: 13px; }
        .grupo-par { background-color: #ffffff !important; }
        .grupo-impar { background-color: #f8f9fa !important; }

        .pill { padding: 5px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 95px; text-transform: uppercase; }

        /* Estilo para itens desativados no modal */
        .filter-item-disabled { background: #f9f9f9; color: #bbb; cursor: not-allowed !important; }
        .filter-item-disabled input { opacity: 0.5; pointer-events: none; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 340px; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { background: var(--red); color: white; padding: 15px; font-weight: bold; text-align: center; }
        .modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px; background: #f1f1f1; }
        .modal-footer button { padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; border: 1px solid #ccc; }
        .btn-aplicar { background: var(--red); color: white; border: none !important; grid-column: span 2; }
    </style>
</head>
<body>

<div id="userBar">
    <div class="back-area">
        <a href="index.html" class="back-arrow">‚Üê</a>
        <span id="userName">Carregando...</span>
    </div>
    <button onclick="fazerLogoff()" style="background:transparent; color:white; border:1px solid #fff; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">SAIR</button>
</div>

<h1>EXPEDI√á√ÉO_M√ìVEIS SIMONETTI</h1>

<div class="dashboard">
    <div class="dashboard-row">
        <div class="chart-box"><canvas id="statusChart"></canvas></div>
        <div class="chart-box"><canvas id="veiculoChart"></canvas></div>
    </div>
    <div id="totalVisual">Calculando...</div>
</div>

<div class="toolbar">
    <input type="text" id="mainSearch" placeholder="üîç Buscar na tabela...">
    <div class="dropdown">
        <button class="btn-share" id="btnShare">COMPARTILHAR ‚ñº</button>
        <div class="dropdown-content" id="dropContent">
            <button onclick="exportarPDF()">üìÑ PDF Profissional (MS)</button>
            <button onclick="exportarExcel()">üìä Planilha Excel</button>
        </div>
    </div>
</div>

<div class="table-container">
    <table id="tabelaExp" class="display nowrap">
        <thead>
            <tr id="headerRow"></tr>
            <tr id="filterRow"></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="modalFiltro" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">FILTRAR COLUNA</div>
        <div class="modal-body" id="listCheckboxes" style="max-height: 350px; overflow-y: auto; padding: 10px;"></div>
        <div class="modal-footer">
            <button onclick="limparFiltroColuna()">LIMPAR</button>
            <button onclick="$('#modalFiltro').hide()">FECHAR</button>
            <button onclick="toggleChecks(true)">TODOS</button>
            <button onclick="toggleChecks(false)">NENHUM</button>              
            <button class="btn-aplicar" onclick="aplicarFiltro()">APLICAR FILTRO</button>
        </div>
    </div>
</div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/1-t9-DE1erEwcgZWVHMHq5JWBqWYAnZvh-_01__3fHno/export?format=csv&gid=0";
const colunas = ["QTD", "DATA", "EXPEDI√á√ÉO", "PLACA", "CENTRAL", "DESTINO", "BOX", "STATUS", "CONFERENTE", "VEICULO", "PESO", "CARREGAMENTO"];

const coresStatus = { "EM SEPARA√á√ÉO": "#FF8C00", "CARREGADO": "#0055b3", "FINALIZADO": "#0b6631", "CANCELADA": "#b30000" };
const coresVeic = { "CARRETA": "#006633", "TRUCK": "#4682B4", "3/4": "#6A5ACD", "PEQUENO": "#6A5ACD", "TOCO": "#8B4513", "RETIRADA": "#DC143C" };

let table, chartStatus, chartVeic, curIdx;

$(document).ready(function() {
    const usuarioAtivo = localStorage.getItem("username") || "Operador";
    $("#userName").text("Bem-vindo, " + usuarioAtivo);

    Papa.parse(csvUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: function(res) { inicializarPagina(res.data); }
    });

    $("#btnShare").on("click", function(e) { e.stopPropagation(); $("#dropContent").toggleClass("show"); });
    $(document).on("click", function(e) { if (!$(e.target).closest(".dropdown").length) $("#dropContent").removeClass("show"); });
});

function inicializarPagina(dados) {
    const h = $("#headerRow").empty();
    const f = $("#filterRow").empty();
    
    colunas.forEach((c, i) => {
        if(i === 0) {
            h.append(`<th style="display:none">${c}</th>`);
            f.append(`<th style="display:none"></th>`);
        } else {
            h.append(`<th>${c}</th>`);
            f.append(`<th><button class="filter-btn" id="fbtn-${i}" onclick="openModal(${i},'${c}')">FILTRAR</button></th>`);
        }
    });

    const body = $("#tabelaExp tbody").empty();
    let ultimoID = null;
    let classeCor = "grupo-par";

    dados.forEach(r => {
        let st = (r.STATUS || "").toUpperCase().trim();
        let vc = (r.VEICULO || "").toUpperCase().trim();
        let qtdVal = r.QTD || "";

        if(!st && !r.DATA) return;
        if (qtdVal && !qtdVal.includes("-") && qtdVal !== ultimoID) {
            classeCor = (classeCor === "grupo-par") ? "grupo-impar" : "grupo-par";
            ultimoID = qtdVal;
        }

        let placaOriginal = r.PLACA || "";
        let placaExibicao = placaOriginal.includes("*") ? `<span style="color:red; font-weight:bold;">${placaOriginal.replace(/\*/g, "")}</span>` : placaOriginal;

        body.append(`<tr class="${classeCor}">
            <td style="display:none">${qtdVal}</td>
            <td>${r.DATA || ""}</td>
            <td>${r["EXPEDI√á√ÉO"] || r.EXPEDICAO || ""}</td>
            <td>${placaExibicao}</td> 
            <td>${r.CENTRAL || ""}</td>
            <td>${r.DESTINO || ""}</td>
            <td>${r.BOX || ""}</td>
            <td><span class="pill" style="background:${coresStatus[st] || '#ccc'}; color:#fff">${st}</span></td>
            <td>${r.CONFERENTE || ""}</td>            
            <td><span class="pill" style="background:${coresVeic[vc] || '#eee'}; color:#fff; border:1px solid #ccc">${vc}</span></td>
            <td>${r.PESO || ""}</td>
            <td>${r.CARREGAMENTO || ""}</td>            
        </tr>`);
    });

    table = $('#tabelaExp').DataTable({ 
        paging: false, info: false, dom: 'rt', scrollX: true, destroy: true, ordering: true, orderCellsTop: true
    });

    $('#mainSearch').on('keyup', function() { table.search(this.value).draw(); updateDashboard(); });
    restaurarFiltrosPermanentes();
    updateDashboard();
}

function updateDashboard() {
    const visibleRows = table.rows({ search: 'applied' }).nodes().to$();
    const idsCargasUnicas = new Set(); 
    let totalComps = 0;
    let totalExpedicoes = 0;
    const statsStatus = {}; 
    const statsVeic = {};

    visibleRows.each(function() {
        totalExpedicoes++; 
        let qtdVal = $(this).find('td:eq(0)').text().trim();
        let status = $(this).find('td:eq(7)').text().trim();
        let veiculo = $(this).find('td:eq(9)').text().trim();
        
        if (qtdVal !== "" && !isNaN(qtdVal)) {
            if (qtdVal.includes("-")) {
                totalComps++;
            } else if (!idsCargasUnicas.has(qtdVal)) {
                idsCargasUnicas.add(qtdVal);
                // Gr√°fico de ve√≠culos baseado em cargas √∫nicas
                statsVeic[veiculo] = (statsVeic[veiculo] || 0) + 1;
            }
        }
        if (status) statsStatus[status] = (statsStatus[status] || 0) + 1;
    });

    $("#totalVisual").html(`
        <div style="line-height: 1.2;">
            <div>Total de Cargas: ${idsCargasUnicas.size} ${totalComps > 0 ? '+ Comp(' + totalComps + ')' : ''}</div>
            <div style="font-size: 13px; color: #666; font-weight: normal;">Total Expedi√ß√µes: ${totalExpedicoes}</div>
        </div>
    `);

    // Bot√µes de Ativo/Filtrar
    colunas.forEach((_, i) => {
        const memory = localStorage.getItem(`exp_filt_${i}`);
        $(`#fbtn-${i}`).toggleClass("filter-applied", !!(memory && JSON.parse(memory).length > 0))
                      .text(memory && JSON.parse(memory).length > 0 ? "ATIVO" : "FILTRAR");
    });

    // Gr√°fico de Status
    if(chartStatus) chartStatus.destroy();
    chartStatus = new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(statsStatus).map(k => `${k}: ${statsStatus[k]}`),
            datasets: [{ data: Object.values(statsStatus), backgroundColor: Object.keys(statsStatus).map(k => coresStatus[k] || "#ccc") }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: true, text: 'STATUS GERAL' } } }
    });

    // Gr√°fico de Ve√≠culos
    if(chartVeic) chartVeic.destroy();
    chartVeic = new Chart(document.getElementById('veiculoChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(statsVeic).map(k => `${k}: ${statsVeic[k]}`),
            datasets: [{ data: Object.values(statsVeic), backgroundColor: Object.keys(statsVeic).map(k => coresVeic[k] || "#ccc") }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: true, text: 'VE√çCULOS (POR CARGA)' } } }
    });
}

function openModal(idx, title) {
    curIdx = idx;
    $("#modalTitle").text(title);
    
    // Filtro inteligente: pega o que existe na coluna inteira vs o que est√° vis√≠vel agora
    const allUnique = table.column(idx).data().unique().sort().toArray().map(v => $(`<span>${v}</span>`).text().trim()).filter(v => v);
    const visibleNow = table.column(idx, {search: 'applied'}).data().unique().toArray().map(v => $(`<span>${v}</span>`).text().trim());
    const salvos = JSON.parse(localStorage.getItem(`exp_filt_${idx}`)) || [];
    
    const list = $("#listCheckboxes").empty();
    const disponiveis = allUnique.filter(v => visibleNow.includes(v));
    const bloqueados = allUnique.filter(v => !visibleNow.includes(v));

    const renderItem = (v, isBlocked) => {
        let checked = (salvos.length === 0 || salvos.includes(v)) ? "checked" : "";
        return `<label style="display:block; padding:8px; border-bottom:1px solid #eee; cursor:pointer;" class="${isBlocked ? 'filter-item-disabled' : ''}">
            <input type="checkbox" value="${v}" ${checked} ${isBlocked ? 'disabled' : ''}> ${v}
        </label>`;
    };

    disponiveis.forEach(v => list.append(renderItem(v, false)));
    bloqueados.forEach(v => list.append(renderItem(v, true)));
    
    $("#modalFiltro").css("display", "flex");
}

function aplicarFiltro() {
    const escolhidos = $("#listCheckboxes input:checked:not(:disabled)").map(function(){ return this.value; }).get();
    const regex = escolhidos.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
    table.column(curIdx).search(regex, true, false).draw();
    localStorage.setItem(`exp_filt_${curIdx}`, JSON.stringify(escolhidos));
    $("#modalFiltro").hide();
    updateDashboard();
}

function limparFiltroColuna() {
    localStorage.removeItem(`exp_filt_${curIdx}`);
    table.column(curIdx).search('').draw();
    $("#modalFiltro").hide();
    updateDashboard();
}

function restaurarFiltrosPermanentes() {
    colunas.forEach((_, i) => {
        const memory = JSON.parse(localStorage.getItem(`exp_filt_${i}`));
        if(memory && memory.length > 0) {
            const regex = memory.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
            table.column(i).search(regex, true, false);
        }
    });
    table.draw();
}

function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const filteredRows = table.rows({ search: 'applied' }).nodes().to$();
    
    doc.setFillColor(178, 34, 34); doc.rect(0, 0, 297, 25, 'F');
    doc.setTextColor(255, 255, 255); doc.setFontSize(28); doc.text("MS", 15, 17);
    doc.setFontSize(16); doc.text("EXPEDI√á√ÉO_M√ìVEIS SIMONETTI", 45, 15);
    
    const bodyData = [];
    filteredRows.each(function() {
        const row = []; 
        $(this).find('td').each(function(idx) { if(idx !== 0) row.push($(this).text().trim()); });
        bodyData.push(row);
    });

    doc.autoTable({
        startY: 35, head: [colunas.slice(1)], body: bodyData,
        styles: { fontSize: 8, halign: 'center' },
        headStyles: { fillColor: [178, 34, 34] },
        didParseCell: function(data) {
            if(data.section === 'body' && data.column.index === 2) { // Placa Vermelha
                const html = table.cell(data.row.index, 3).node().innerHTML;
                if(html.includes('color:red')) { data.cell.styles.textColor = [255, 0, 0]; data.cell.styles.fontStyle = 'bold'; }
            }
        }
    });
    doc.save("Relatorio_Expedicao_MS.pdf");
}

function exportarExcel() {
    const wb = XLSX.utils.table_to_book(document.getElementById('tabelaExp'));
    XLSX.writeFile(wb, "Expedicao_Simonetti.xlsx");
}

function toggleChecks(b) { $("#listCheckboxes input:not(:disabled)").prop("checked", b); }
function fazerLogoff() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>
</html>
