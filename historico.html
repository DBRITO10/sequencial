<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>HIST√ìRICO SIMONETTI - OFICIAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

    <style>
        :root { 
            --blue: #004080; 
            --dark-blue: #002d5a;
            --user-bar-bg: #0056b3;
            --bg: #f0f4f8; 
        }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; }
        
        #userBar { background: var(--user-bar-bg); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; color: white; margin-bottom: 10px; }
        .back-area { display: flex; align-items: center; gap: 15px; }
        .back-arrow { cursor: pointer; font-size: 24px; text-decoration: none; color: white; }
        
        h1 { background: var(--blue); color: white; text-align: center; padding: 15px; border-radius: 4px; margin: 0 0 10px 0; font-size: 20px; text-transform: uppercase; }

        /* Resumo de Ve√≠culos em Azul */
        .summary-panel { 
            background: white; padding: 15px; border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
        }
        .stat-badge { 
            background: #e7eff6; color: var(--blue); border: 1px solid var(--blue);
            padding: 8px 15px; border-radius: 5px; font-size: 13px; font-weight: bold;
        }
        
        #totalVisual { 
            font-size: 18px; font-weight: bold; color: white; 
            margin: 5px auto 15px; background: var(--blue); 
            padding: 10px 25px; border-radius: 50px; 
            display: block; width: fit-content; text-align: center;
        }

        .toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; align-items: center; }
        #mainSearch { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 220px; outline: none; }
        
        .btn-action { background: #28a745; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .table-container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        
        /* Ajuste do Header */
        table.dataTable { width: 100% !important; border-collapse: collapse !important; }
        table.dataTable thead th { 
            background: var(--blue) !important; color: white !important; 
            text-align: center !important; padding: 10px 18px 10px 5px !important;
            border: 1px solid var(--dark-blue) !important; font-size: 12px;
            position: relative; cursor: pointer; text-transform: uppercase;
        }

        /* Setas Fixas */
        table.dataTable thead .sorting:after, table.dataTable thead .sorting_asc:after, table.dataTable thead .sorting_desc:after {
            right: 4px !important; content: "‚Üï" !important; opacity: 0.6 !important; font-size: 14px !important;
        }
        table.dataTable thead .sorting_asc:after { content: "‚Üë" !important; opacity: 1 !important; }
        table.dataTable thead .sorting_desc:after { content: "‚Üì" !important; opacity: 1 !important; }

        table.dataTable tbody td { border: 1px solid #dee2e6 !important; text-align: center !important; padding: 8px !important; font-size: 13px; }
        
        .col-hidden { display: none !important; }

        .filter-btn { 
            width: 90%; margin: 4px auto 0; padding: 4px 0; font-size: 10px; 
            background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); 
            border-radius: 3px; cursor: pointer; font-weight: bold; display: block;
        }
        .filter-applied { background: #FFD700 !important; color: #000 !important; }
        
        .item-disabled { color: #999; opacity: 0.6; background: #f9f9f9; }
        .pill { padding: 5px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 95px; text-transform: uppercase; color: #fff; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 320px; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { background: var(--blue); color: white; padding: 15px; font-weight: bold; text-align: center; }
        .modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px; background: #f1f1f1; }
    </style>
</head>
<body>

<div id="userBar">
    <div class="back-area"><a href="index.html" class="back-arrow">‚Üê</a> <span id="userName">Usu√°rio</span></div>
    <button onclick="fazerLogoff()" style="background:transparent; color:white; border:1px solid #fff; padding:6px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">SAIR</button>
</div>

<h1>HIST√ìRICO DE EXPEDI√á√ÉO</h1>

<div id="totalVisual">Carregando dados...</div>

<div class="summary-panel" id="veicSummary"></div>

<div class="toolbar">
    <input type="text" id="mainSearch" placeholder="üîç Buscar no hist√≥rico...">
    <button class="btn-action" onclick="exportarPDF()">üìÑ PDF</button>
    <button class="btn-action" style="background:#007bff" onclick="exportarExcel()">üìä EXCEL</button>
</div>

<div class="table-container">
    <table id="tabelaExp" class="display nowrap">
        <thead>
            <tr id="headerRow"></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="modalFiltro" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">FILTRAR</div>
        <div class="modal-body" id="listCheckboxes" style="max-height: 300px; overflow-y: auto; padding: 10px;"></div>
        <div class="modal-footer">
            <button onclick="limparFiltroColuna()">LIMPAR</button>
            <button onclick="$('#modalFiltro').hide()">FECHAR</button>
            <button onclick="toggleChecks(true)">TODOS</button>
            <button onclick="toggleChecks(false)">NENHUM</button>              
            <button class="btn-aplicar" onclick="aplicarFiltro()" style="grid-column: span 2; background: var(--blue); color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold;">APLICAR</button>
        </div>
    </div>
</div>

<script>
// URL do Hist√≥rico (gid=1152869502)
const csvUrl = "https://docs.google.com/spreadsheets/d/1-t9-DE1erEwcgZWVHMHq5JWBqWYAnZvh-_01__3fHno/export?format=csv&gid=1152869502";
const colunas = ["QTD", "DATA", "EXPEDI√á√ÉO", "PLACA", "CENTRAL", "DESTINO", "BOX", "STATUS", "CONFERENTE", "VEICULO", "PESO", "CARREGAMENTO"];
const coresStatus = { "EM SEPARA√á√ÉO": "#FF8C00", "CARREGADO": "#0055b3", "FINALIZADO": "#0b6631", "CANCELADA": "#b30000" };
const coresVeic = { "CARRETA": "#006633", "TRUCK": "#4682B4", "3/4": "#6A5ACD", "PEQUENO": "#6A5ACD", "TOCO": "#8B4513", "RETIRADA": "#DC143C" };

let table, curIdx;

$(document).ready(function() {
    $("#userName").text("Hist√≥rico: " + (localStorage.getItem("username") || "Operador"));
    Papa.parse(csvUrl, { download: true, header: true, skipEmptyLines: true, complete: res => inicializarPagina(res.data) });
});

function inicializarPagina(dados) {
    const h = $("#headerRow").empty();
    colunas.forEach((c, i) => {
        h.append(`<th class="${i===0?'col-hidden':''}">
            <div>${c}</div>
            <button class="filter-btn" id="fbtn-${i}" onclick="event.stopPropagation(); openModal(${i},'${c}')">FILTRAR</button>
        </th>`);
    });

    const body = $("#tabelaExp tbody").empty();
    dados.forEach(r => {
        let st = (r.STATUS || "").toUpperCase().trim();
        let vc = (r.VEICULO || "").toUpperCase().trim();
        if(!st && !r.DATA) return;
        let placaHtml = (r.PLACA || "").includes("*") ? `<span style="color:red; font-weight:bold;">${r.PLACA.replace(/\*/g, "")}</span>` : (r.PLACA || "");

        body.append(`<tr>
            <td class="col-hidden">${r.QTD || ""}</td>
            <td>${r.DATA || ""}</td>
            <td>${r["EXPEDI√á√ÉO"] || r.EXPEDICAO || ""}</td>
            <td>${placaHtml}</td> 
            <td>${r.CENTRAL || ""}</td>
            <td>${r.DESTINO || ""}</td>
            <td>${r.BOX || ""}</td>
            <td><span class="pill" style="background:${coresStatus[st] || '#ccc'}">${st}</span></td>
            <td>${r.CONFERENTE || ""}</td>            
            <td><span class="pill" style="background:${coresVeic[vc] || '#eee'}; border:1px solid #ccc; color:#333">${vc}</span></td>
            <td>${r.PESO || ""}</td>
            <td>${r.CARREGAMENTO || ""}</td>            
        </tr>`);
    });

    table = $('#tabelaExp').DataTable({ paging: false, info: false, dom: 'rt', scrollX: true, destroy: true, ordering: true });
    $('#mainSearch').on('keyup', function() { table.search(this.value).draw(); updateDashboard(); });
    
    // Restaurar filtros espec√≠ficos do hist√≥rico (Chave hist_filt)
    colunas.forEach((_, i) => {
        let m = JSON.parse(localStorage.getItem(`hist_filt_${i}`));
        if(m && m.length > 0) table.column(i).search(m.map(v => '^'+$.fn.dataTable.util.escapeRegex(v)+'$').join('|'), true, false);
    });
    table.draw();
    updateDashboard();
}

function openModal(idx, title) {
    curIdx = idx; $("#modalTitle").text(title);
    const allUnique = table.column(idx, { filter: 'none' }).data().unique().sort().toArray().map(v => v.replace(/<[^>]*>/g, "").trim()).filter(v => v !== "");
    const currentViewUnique = table.column(idx, { filter: 'applied' }).data().unique().toArray().map(v => v.replace(/<[^>]*>/g, "").trim());
    const list = $("#listCheckboxes").empty();
    const salvos = JSON.parse(localStorage.getItem(`hist_filt_${idx}`)) || [];

    let disponiveis = allUnique.filter(v => currentViewUnique.includes(v));
    let indisponiveis = allUnique.filter(v => !currentViewUnique.includes(v));

    const criarItem = (v, isDisabled) => {
        const isChecked = salvos.length === 0 || salvos.includes(v);
        list.append(`<label class="${isDisabled?'item-disabled':''}" style="display:block; padding:8px; border-bottom:1px solid #eee; cursor:pointer;">
            <input type="checkbox" value="${v}" ${isChecked?"checked":""}> ${v}
        </label>`);
    };

    disponiveis.forEach(v => criarItem(v, false));
    if(indisponiveis.length > 0) {
        list.append(`<div style="background:#eee; padding:5px; font-size:10px; font-weight:bold; text-align:center;">INDISPON√çVEIS NESTE FILTRO</div>`);
        indisponiveis.forEach(v => criarItem(v, true));
    }
    $("#modalFiltro").css("display", "flex");
}

function aplicarFiltro() {
    const sel = $("#listCheckboxes input:checked").map(function(){ return this.value; }).get();
    const total = $("#listCheckboxes input").length;
    if(sel.length === total) {
        limparFiltroColuna();
    } else {
        table.column(curIdx).search(sel.length ? sel.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|') : 'NONE', true, false).draw();
        localStorage.setItem(`hist_filt_${curIdx}`, JSON.stringify(sel));
        $("#modalFiltro").hide(); updateDashboard();
    }
}

function limparFiltroColuna() { 
    localStorage.removeItem(`hist_filt_${curIdx}`); 
    table.column(curIdx).search('').draw(); 
    $("#modalFiltro").hide(); updateDashboard(); 
}

function updateDashboard() {
    const visibleRows = table.rows({ search: 'applied' }).nodes().to$();
    const idsCargas = new Set(); 
    let exped = 0;
    const vStat = {};

    visibleRows.each(function() {
        exped++;
        let q = $(this).find('td:eq(0)').text().trim();
        let vc = $(this).find('td:eq(9)').text().trim();
        if (q !== "" && !isNaN(q) && !q.includes("-")) {
            if(!idsCargas.has(q)) { idsCargas.add(q); vStat[vc] = (vStat[vc] || 0) + 1; }
        }
    });

    $("#totalVisual").html(`Cargas no Hist√≥rico: ${idsCargas.size} | Total de Linhas: ${exped}`);
    
    // Resumo de Ve√≠culos por Tipo
    let htmlVeic = "";
    Object.keys(vStat).sort().forEach(v => {
        htmlVeic += `<div class="stat-badge">${v}: ${vStat[v]}</div>`;
    });
    $("#veicSummary").html(htmlVeic || "Nenhum ve√≠culo filtrado");

    colunas.forEach((_, i) => {
        let mem = localStorage.getItem(`hist_filt_${i}`);
        $(`#fbtn-${i}`).toggleClass("filter-applied", !!mem).text(mem ? "ATIVO" : "FILTRAR");
    });
}

function exportarPDF() {
    const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4');
    doc.setFillColor(0, 64, 128); doc.rect(0, 0, 297, 20, 'F');
    doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("HIST√ìRICO SIMONETTI", 15, 13);
    const body = [];
    table.rows({ search: 'applied' }).nodes().to$().each(function() {
        let r = []; $(this).find('td').each((i, td) => { if(i>0) r.push($(td).text().trim()); }); body.push(r);
    });
    doc.autoTable({ startY: 25, head: [colunas.slice(1)], body: body, styles: { fontSize: 7, halign: 'center' }, headStyles: { fillColor: [0, 64, 128] } });
    doc.save("Historico_MS.pdf");
}

function exportarExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('tabelaExp')), "Historico_Simonetti.xlsx"); }
function toggleChecks(b) { $("#listCheckboxes input").prop("checked", b); }
function fazerLogoff() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>
</html>
